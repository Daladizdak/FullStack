<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1">
				<title>Add a Movie</title>
				<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
					  crossorigin="anonymous">
				</head>
	<body>
		<div class="container">
			<h1>Add a Movie</h1>

			{# general error (e.g. blank fields) from server #}
			{% if error is defined and error %}
			<div class="alert alert-danger">{{ error }}</div>
			{% endif %}

			<form id="addMovieForm" action="add_movie.php" method="post">

				<div class="mb-3">
					<label for="MovieName" class="form-label">Movie name</label>
					<input type="text" class="form-control" id="MovieName" name="MovieName" required="">
						<div id="movieError" class="text-danger mt-1"></div>
					</div>

				<div class="mb-3">
					<label for="Genre" class="form-label">Genre</label>
					<input type="text" class="form-control" id="Genre" name="Genre" required="">
        </div>

				<div class="mb-3">
					<label for="ReleaseDate" class="form-label">Release date</label>
					<input type="date" class="form-control" id="ReleaseDate" name="ReleaseDate" required="">
        </div>

				<div class="mb-3">
					<label for="Score" class="form-label">Score</label>
					<input type="number" class="form-control" id="Score" name="Score" required="">
        </div>

				<div id="formError" class="text-danger mb-2"></div>

				<input type="submit" class="btn btn-primary" value="Add movie">
    </form>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
			const form = document.getElementById('addMovieForm');
			const movieInput = document.getElementById('MovieName');
			const genreInput = document.getElementById('Genre');
			const releaseInput = document.getElementById('ReleaseDate');
			const scoreInput = document.getElementById('Score');

			const movieError = document.getElementById('movieError');
			const formError = document.getElementById('formError');

			form.addEventListener('submit', function (e) {
			e.preventDefault(); // stop normal submit first

			movieError.textContent = '';
			formError.textContent = '';

			const movieName = movieInput.value.trim();
			const genre = genreInput.value.trim();
			const releaseDate = releaseInput.value.trim();
			const score = scoreInput.value.trim();

			
			if (!movieName || !genre || !releaseDate || !score) {
			formError.textContent = 'Please fill in all fields before adding a movie.';
			return;
			}

			
			fetch('check-movie.php', {
			method: 'POST',
			headers: {
			'Content-Type': 'application/x-www-form-urlencoded'
			},
			body: 'MovieName=' + encodeURIComponent(movieName)
			})
			.then(response => response.json())
			.then(data => {
			if (data.exists) {
			movieError.textContent = 'This movie is already in the database.';
			} else {
			
			form.submit();
			}
			})
			.catch(err => {
			// If AJAX fails for some reason, still submit (server will validate too)
			console.error(err);
			form.submit();
			});
			});

			// clear “already exists” message while typing
			movieInput.addEventListener('input', function () {
			movieError.textContent = '';
			});
			});
		</script>
	</body>
</html>
