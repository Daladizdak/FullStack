<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
			<meta name="viewport" content="width=device-width, initial-scale=1">
				<title>My Movies</title>
				<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

	<body>
		<div class="container mt-4">
			<h1 class="mb-4">Best Movies Of All time</h1>

			{% if success %}
			<div id="successMessage" class="alert alert-success">
				Movie added successfully!
			</div>

			<script>
				setTimeout(function() {
				const msg = document.getElementById('successMessage');
				if (msg) {
				msg.style.transition = "opacity 0.5s";
				msg.style.opacity = "0";
				setTimeout(() => msg.remove(), 500);
				}
				}, 10000); // 10 seconds
			</script>
			{% endif %}

			<div class="row mb-3">
				<div class="col-md-4">
					<input
						type="text"
						class="form-control"
						id="searchBox"
						placeholder="Search by movie name or genre">

						
						<ul id="suggestions" class="list-group mt-1"></ul>

						<div id="spinner" class="text-primary my-2" style="display:none;">
							<div class="spinner-border spinner-border-sm" role="status"></div>
							<span class="ms-1">Searchingâ€¦</span>
						</div>
						
					</div>
			</div>

			<table class="table table-striped">
				<thead>
					<tr>
						<th>Movie Name</th>
						<th>Genre</th>
						<th>Release date</th>
						<th>Score</th>
						<th>Adjust</th>
					</tr>
				</thead>

				<tbody id="movieTableBody">
					{# initial list from PHP #}
					{% for movie in movies %}
					<tr id="movie-row-{{ movie.Movie_id }}">
						<td>{{ movie.Movie_name }}</td>
						<td>{{ movie.Genre }}</td>
						<td>{{ movie.Release_Date }}</td>
						<td>{{ movie.Score|number_format(0) }}/100</td>
						<td>
							<button
								class="btn btn-sm btn-primary btn-edit"
								data-id="{{ movie.Movie_id }}"
								data-name="{{ movie.Movie_name }}"
								data-genre="{{ movie.Genre }}"
								data-date="{{ movie.Release_Date }}"
								data-score="{{ movie.Score }}">
								Edit
							</button>
							<button
								class="btn btn-sm btn-danger btn-delete"
								data-id="{{ movie.Movie_id }}">
								Delete
							</button>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			
			<button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addMovieModal">
				Add a Movie
			</button>

			<p id="noResultsMessage" class="text-muted" style="display:none;">No movies found.</p>
		</div>

		{# Add Movie Modal #}
		<div class="modal fade" id="addMovieModal" tabindex="-1" aria-labelledby="addMovieLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="addMovieLabel">Add a Movie</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="addMovieForm">
							<div class="mb-3">
								<label for="MovieName" class="form-label">Movie Name</label>
								<input type="text" class="form-control" id="MovieName" name="MovieName" required="">
					</div>
							<div class="mb-3">
								<label for="Genre" class="form-label">Genre</label>
								<input type="text" class="form-control" id="Genre" name="Genre" required="">
					</div>
							<div class="mb-3">
								<label for="ReleaseDate" class="form-label">Release Date</label>
								<input type="date" class="form-control" id="ReleaseDate" name="ReleaseDate" required="">
					</div>
							<div class="mb-3">
								<label for="Score" class="form-label">Score</label>
								<input type="number" class="form-control" id="Score" name="Score" required="">
					</div>
							<div id="addError" class="text-danger mb-2"></div>
							<button type="submit" class="btn btn-primary">Save movie</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		{# Edit Movie Modal #}
		<div class="modal fade" id="editMovieModal" tabindex="-1" aria-labelledby="editMovieLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="editMovieLabel">Edit Movie</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="editMovieForm">
							<input type="hidden" id="EditMovieId" name="Movie_id">

								<div class="mb-3">
									<label for="EditMovieName" class="form-label">Movie Name</label>
									<input type="text" class="form-control" id="EditMovieName" name="MovieName" required="">
					</div>
								<div class="mb-3">
									<label for="EditGenre" class="form-label">Genre</label>
									<input type="text" class="form-control" id="EditGenre" name="Genre" required="">
					</div>
								<div class="mb-3">
									<label for="EditReleaseDate" class="form-label">Release Date</label>
									<input type="date" class="form-control" id="EditReleaseDate" name="ReleaseDate" required="">
					</div>
								<div class="mb-3">
									<label for="EditScore" class="form-label">Score</label>
									<input type="number" class="form-control" id="EditScore" name="Score" required="">
					</div>

								<div id="editError" class="text-danger mb-2"></div>
								<button type="submit" class="btn btn-primary">Save changes</button>
							</form>
					</div>
				</div>
			</div>
		</div>


		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous">	
		</script>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
				crossorigin="anonymous"></script>

		<script>
			document.addEventListener('DOMContentLoaded', () => {
			const searchBox = document.getElementById("searchBox");
			const tableBody = document.getElementById("movieTableBody");
			const noResultsMessage = document.getElementById("noResultsMessage");
			const suggestions = document.getElementById("suggestions");
			const spinner = document.getElementById("spinner");

			const addMovieForm = document.getElementById('addMovieForm');
			const addError = document.getElementById('addError');
			const addMovieModalEl = document.getElementById('addMovieModal');
			const addMovieModal = addMovieModalEl ? new bootstrap.Modal(addMovieModalEl) : null;

			const editMovieForm = document.getElementById('editMovieForm');
			const editError = document.getElementById('editError');
			const editMovieModalEl = document.getElementById('editMovieModal');
			const editMovieModal = editMovieModalEl ? new bootstrap.Modal(editMovieModalEl) : null;

			if (!searchBox) {
			console.error('Search box not found');
			return;
			}

		

			function clearSuggestions() {
			suggestions.innerHTML = '';
			}

			function renderSuggestions(movies) {
			clearSuggestions();

			const keywords = searchBox.value.trim();
			if (keywords.length < 2) {
            return;
        }

        const limited = movies.slice(0, 5);

        limited.forEach(movie => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action';
            li.textContent = movie.Movie_name;

            li.addEventListener('click', () => {
                searchBox.value = movie.Movie_name;
                clearSuggestions();
                doSearch();
            });

            suggestions.appendChild(li);
        });
    }

    function doSearch() {
        const keywords = searchBox.value;

        spinner.style.display = 'inline-block';

        fetch('search_movies.php?search=' + encodeURIComponent(keywords))
            .then(response => response.json())
            .then(movies => {
                spinner.style.display = 'none';

                tableBody.innerHTML = '';

                if (!Array.isArray(movies) || movies.length === 0) {
                    noResultsMessage.style.display = 'block';
                    clearSuggestions();
                    return;
                }

                noResultsMessage.style.display = 'none';

                movies.forEach(movie => {
                    const row = document.createElement('tr');
                    row.id = 'movie-row-' + movie.Movie_id;
                    row.innerHTML = `
                        <td>${movie.Movie_name}</td>
			<td>${movie.Genre}</td>
			<td>${movie.Release_Date}</td>
			<td>${parseInt(movie.Score, 10)}/100</td>
			<td>
				<button
					class="btn btn-sm btn-primary btn-edit"
					data-id="${movie.Movie_id}"
					data-name="${movie.Movie_name}"
					data-genre="${movie.Genre}"
					data-date="${movie.Release_Date}"
					data-score="${movie.Score}">
					Edit
				</button>
				<button
					class="btn btn-sm btn-danger btn-delete"
					data-id="${movie.Movie_id}">
					Delete
				</button>
			</td>
			`;
			tableBody.appendChild(row);
			});

			renderSuggestions(movies);
			})
			.catch(error => {
			console.error('Search error:', error);
			spinner.style.display = 'none';
			clearSuggestions();
			});
			}

			searchBox.addEventListener("keyup", doSearch);

			// Hide suggestions when clicking outside
			document.addEventListener('click', (e) => {
			if (!searchBox.contains(e.target) && !suggestions.contains(e.target)) {
			clearSuggestions();
			}
			});

			

			if (addMovieForm) {
			addMovieForm.addEventListener('submit', function (e) {
			e.preventDefault();

			addError.textContent = '';

			const formData = new URLSearchParams();
			formData.append('MovieName', document.getElementById('MovieName').value.trim());
			formData.append('Genre', document.getElementById('Genre').value.trim());
			formData.append('ReleaseDate', document.getElementById('ReleaseDate').value.trim());
			formData.append('Score', document.getElementById('Score').value.trim());

			fetch('add_movie.php', {
			method: 'POST',
			headers: {
			'Content-Type': 'application/x-www-form-urlencoded'
			},
			body: formData.toString()
			})
			.then(res => res.json())
			.then(data => {
			if (!data.success) {
			addError.textContent = data.error || 'Something went wrong.';
			return;
			}

			const movie = data.movie;

			const row = document.createElement('tr');
			row.id = 'movie-row-' + movie.Movie_id;
			row.innerHTML = `
			<td>${movie.Movie_name}</td>
			<td>${movie.Genre}</td>
			<td>${movie.Release_Date}</td>
			<td>${movie.Score}/100</td>
			<td>
				<button
					class="btn btn-sm btn-primary btn-edit"
					data-id="${movie.Movie_id}"
					data-name="${movie.Movie_name}"
					data-genre="${movie.Genre}"
					data-date="${movie.Release_Date}"
					data-score="${movie.Score}">
					Edit
				</button>
				<button
					class="btn btn-sm btn-danger btn-delete"
					data-id="${movie.Movie_id}">
					Delete
				</button>
			</td>
			`;

			tableBody.appendChild(row);
			noResultsMessage.style.display = 'none';

			addMovieForm.reset();
			if (addMovieModal) addMovieModal.hide();
			})
			.catch(err => {
			console.error(err);
			addError.textContent = 'Network error.';
			});
			});
			}

			

			tableBody.addEventListener('click', function (e) {
			const deleteBtn = e.target.closest('.btn-delete');
			const editBtn = e.target.closest('.btn-edit');

	
			if (deleteBtn) {
			const id = deleteBtn.getAttribute('data-id');
			if (!confirm('Are you sure you want to delete this movie?')) {
			return;
			}

			const body = new URLSearchParams();
			body.append('id', id);

			fetch('delete_movie.php', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: body.toString()
			})
			.then(res => res.json())
			.then(data => {
			if (data.success) {
			const row = document.getElementById('movie-row-' + id);
			if (row) row.remove();
			} else {
			alert(data.error || 'Failed to delete movie.');
			}
			})
			.catch(err => {
			console.error(err);
			alert('Network error while deleting.');
			});

			return;
			}

			if (editBtn) {
			const id    = editBtn.getAttribute('data-id');
			const name  = editBtn.getAttribute('data-name');
			const genre = editBtn.getAttribute('data-genre');
			const date  = editBtn.getAttribute('data-date');
			const score = editBtn.getAttribute('data-score');

			document.getElementById('EditMovieId').value = id;
			document.getElementById('EditMovieName').value = name;
			document.getElementById('EditGenre').value = genre;
			document.getElementById('EditReleaseDate').value = date;
			document.getElementById('EditScore').value = score;

			if (editMovieModal) {
			editError.textContent = '';
			editMovieModal.show();
			}
			}
			});

		

			if (editMovieForm) {
			editMovieForm.addEventListener('submit', function (e) {
			e.preventDefault();

			editError.textContent = '';

			const body = new URLSearchParams();
			body.append('Movie_id', document.getElementById('EditMovieId').value);
			body.append('MovieName', document.getElementById('EditMovieName').value.trim());
			body.append('Genre', document.getElementById('EditGenre').value.trim());
			body.append('ReleaseDate', document.getElementById('EditReleaseDate').value.trim());
			body.append('Score', document.getElementById('EditScore').value.trim());

			fetch('update_movie.php', {
			method: 'POST',
			headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
			body: body.toString()
			})
			.then(res => res.json())
			.then(data => {
			if (!data.success) {
			editError.textContent = data.error || 'Failed to update movie.';
			return;
			}

			const movie = data.movie;
			const row = document.getElementById('movie-row-' + movie.Movie_id);

			if (row) {
			row.innerHTML = `
			<td>${movie.Movie_name}</td>
			<td>${movie.Genre}</td>
			<td>${movie.Release_Date}</td>
			<td>${movie.Score}/100</td>
			<td>
				<button
					class="btn btn-sm btn-primary btn-edit"
					data-id="${movie.Movie_id}"
					data-name="${movie.Movie_name}"
					data-genre="${movie.Genre}"
					data-date="${movie.Release_Date}"
					data-score="${movie.Score}">
					Edit
				</button>
				<button
					class="btn btn-sm btn-danger btn-delete"
					data-id="${movie.Movie_id}">
					Delete
				</button>
			</td>
			`;
			}

			if (editMovieModal) {
			editMovieModal.hide();
			}
			})
			.catch(err => {
			console.error(err);
			editError.textContent = 'Network error.';
			});
			});
			}
			});
		</script>


	</body>
</html>
