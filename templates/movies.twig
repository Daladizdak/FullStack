<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>My Movies</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
	<div class="container mt-4">
		<h1 class="mb-4">Best Movies Of All time</h1>

		{% if success %}
			<div id="successMessage" class="alert alert-success">
				Movie added successfully!
			</div>

			<script>
				setTimeout(function() {
				const msg = document.getElementById('successMessage');
				if (msg) {
				msg.style.transition = "opacity 0.5s";
				msg.style.opacity = "0";
				setTimeout(() => msg.remove(), 500);
				}
				}, 10000); // 10 seconds
			</script>
		{% endif %}

		<div class="row mb-3">
			<div class="col-md-4">
				<input 
					type="text" 
					class="form-control" 
					id="searchBox" 
					placeholder="Search by movie name or genre">
			</div>
		</div>

		<a href="add_movie.php" class="btn btn-success mb-3">Add a Movie</a>

		<table class="table table-striped">
			<thead>
				<tr>
					<th>Movie Name</th>
					<th>Genre</th>
					<th>Release date</th>
					<th>Score</th>
				</tr>
			</thead>

			<tbody id="movieTableBody">
				{# initial list from PHP #}
				{% for movie in movies %}
					<tr>
						<td>{{ movie.Movie_name }}</td>
						<td>{{ movie.Genre }}</td>
						<td>{{ movie.Release_Date }}</td>
						<td>{{ movie.Score|number_format(0) }}/100</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>

		<p id="noResultsMessage" class="text-muted" style="display:none;">No movies found.</p>
	</div>

	<script>
		// Wait until the page is loaded so elements exist
		document.addEventListener('DOMContentLoaded', () => {
			const searchBox = document.getElementById("searchBox");
			const tableBody = document.getElementById("movieTableBody");
			const noResultsMessage = document.getElementById("noResultsMessage");

			if (!searchBox) {
				console.error('Search box not found');
				return;
			}

			searchBox.addEventListener("keyup", doSearch);

			function doSearch() {
				const keywords = searchBox.value;

				// Debug line so you can see it's running
				console.log("Searching for:", keywords);

				fetch('search_movies.php?search=' + encodeURIComponent(keywords))
					.then(response => response.json())
					.then(movies => {
						// Clear table
						tableBody.innerHTML = '';

						if (!Array.isArray(movies) || movies.length === 0) {
							noResultsMessage.style.display = 'block';
							return;
						} else {
							noResultsMessage.style.display = 'none';
						}

						movies.forEach(movie => {
							const row = document.createElement('tr');
							row.innerHTML = `
								<td>${movie.Movie_name}</td>
								<td>${movie.Genre}</td>
								<td>${movie.Release_Date}</td>
								<td>${parseInt(movie.Score, 10)}/100</td>
							`;
							tableBody.appendChild(row);
						});
					})
					.catch(error => {
						console.error('Search error:', error);
					});
			}
		});
	</script>
</body>
</html>
